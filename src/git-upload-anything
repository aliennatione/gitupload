#!/usr/bin/env bash
#
# git-upload-anything (v2 universal, fixed)
# Uploads any local directory or zip file to a GitHub repository automatically.
# Supports multiple accounts and global installation.
#
# üîß Requirements: bash, git, curl, unzip, gh, sudo
# üåç Compatible: Termux, Linux (Debian/Ubuntu/Arch/Fedora), macOS
# üß† Features:
#   - Detects/installs missing dependencies
#   - Multi-account GitHub support (--account <username>)
#   - Handles ZIP or folder sources
#   - CLI flags for full automation
#   - Optional cleanup (--cleanup)
#   - Logs operations clearly
#   - Automatically initializes Git repo if missing
#
# ü™™ Auth notes:
#   - If `gh auth login` cannot open a browser, copy/paste the shown URL manually.
#   - Works in WSL/Termux/headless environments too.

set -e

show_help() {
cat <<EOF
Usage: git-upload-anything [OPTIONS]

Options:
  --source <path>        Path to folder or zip file to upload
  --repo <name>          Repository name to create on GitHub
  --private              Make repository private (default: public)
  --cleanup              Remove
```

temporary files after upload
--account <username>   Switch to GitHub account (if multiple)
--help                 Show this help

Examples:
git-upload-anything --source ./myapp.zip --repo MyRepo --private
git-upload-anything --source ./folder --repo Project --cleanup --account work

EOF
exit 0
}

log() { echo -e "[INFO] $*"; }
err() { echo -e "[ERR] $*" >&2; exit 1; }

# Parse CLI args

SOURCE=""
REPO=""
PRIVATE=false
CLEANUP=false
ACCOUNT=""

while [[ $# -gt 0 ]]; do
case "$1" in
--source) SOURCE="$2"; shift 2;;
--repo) REPO="$2"; shift 2;;
--private) PRIVATE=true; shift;;
--cleanup) CLEANUP=true; shift;;
--account) ACCOUNT="$2"; shift 2;;
--help) show_help;;
*) err "Unknown argument: $1";;
esac
done

[[ -z "$SOURCE" || -z "$REPO" ]] && show_help

# Check/install dependencies

check_dep() {
local dep=$1
if ! command -v "$dep" >/dev/null 2>&1; then
echo "[WARN] Missing dependency: $dep"
install_dep "$dep"
fi
}

install_dep() {
local dep=$1
echo "[INFO] Installing $dep ..."
if command -v pkg >/dev/null 2>&1; then pkg install -y "$dep"
elif command -v apt >/dev/null 2>&1; then sudo apt update && sudo apt install -y "$dep"
elif command -v pacman >/dev/null 2>&1; then sudo pacman -Sy "$dep" --noconfirm
elif command -v brew >/dev/null 2>&1; then brew install "$dep"
else err "Cannot install $dep: no supported package manager found"
fi
}

for dep in git curl unzip gh sudo; do check_dep "$dep"; done

# Switch account if specified

if [[ -n "$ACCOUNT" ]]; then
log "Switching to GitHub account: $ACCOUNT"
gh auth login --hostname github.com --git-protocol https --web
fi

# Authenticate GH if needed

if ! gh auth status >/dev/null 2>&1; then
log "GitHub CLI not authenticated. Starting login..."
gh auth login
fi

# Prepare workspace

if [[ -f "$SOURCE" && "$SOURCE" == *.zip ]]; then
TMP_DIR=$(mktemp -d)
log "Extracting zip: $SOURCE -> $TMP_DIR"
unzip -q "$SOURCE" -d "$TMP_DIR"
cd "$TMP_DIR"
elif [[ -d "$SOURCE" ]]; then
cd "$SOURCE"
else
err "Invalid source: $SOURCE"
fi

# Initialize Git repo if missing

if [ ! -d ".git" ]; then
log "Initializing local git repository..."
git init >/dev/null
git add . >/dev/null
git commit -m "Initial commit" >/dev/null
else

# If already a repo but empty, ensure at least one commit

if [ -z "$(git log --oneline 2>/dev/null)" ]; then
log "Repository exists but has no commits. Creating first commit..."
git add . >/dev/null
git commit -m "Initial commit" >/dev/null
fi
fi

# GitHub repo setup

REPO_VISIBILITY="public"
$PRIVATE && REPO_VISIBILITY="private"

log "Creating GitHub repository '$REPO' ($REPO_VISIBILITY)"
if ! gh repo create "$REPO" --"$REPO_VISIBILITY" --source=. --remote=origin --push; then
err "Failed to create/push repo. Check GH authentication or name conflicts."
fi

# Cleanup

if $CLEANUP; then
log "Cleaning up temporary files..."
[[ -n "$TMP_DIR" ]] && rm -rf "$TMP_DIR"
fi

log "‚úÖ Repository '$REPO' successfully uploaded to GitHub!"
